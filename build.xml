<?xml version="1.0"?>
<project name="TrekBuddy" default="all" basedir=".">

    <taskdef resource="antenna.properties" classpath="lib/antenna-bin-0.9.14.jar"/>

    <property name="wtk.home" value="c:\WTK25"/>
    <property name="wtk.cldc.version" value="1.1"/>
    <property name="wtk.midp.version" value="2.0"/>

    <path id="bootclasspath">
        <pathelement location="${wtk.home}\lib\cldcapi11.jar"/>
        <pathelement location="${wtk.home}\lib\midpapi20.jar"/>
        <pathelement location="${wtk.home}\lib\jsr75.jar"/>
        <pathelement location="${wtk.home}\lib\jsr082.jar"/>
        <pathelement location="${wtk.home}\lib\jsr179.jar"/>
        <pathelement location="${wtk.home}\lib\wma11.jar"/>
        <pathelement location="${wtk.home}\lib\mmapi.jar"/>
        <pathelement location="lib\motorola.jar"/>
        <pathelement location="lib\nokia-ui.jar"/>
        <pathelement location="lib\siemens-file.jar"/>
        <pathelement location="lib\siemens-game.jar"/>
    </path>
    
    <path id="bootclasspath10">
        <pathelement location="${wtk.home}\lib\cldcapi10.jar"/>
        <pathelement location="${wtk.home}\lib\midpapi20.jar"/>
        <pathelement location="${wtk.home}\lib\jsr75.jar"/>
        <pathelement location="${wtk.home}\lib\jsr082.jar"/>
        <pathelement location="${wtk.home}\lib\jsr179.jar"/>
        <pathelement location="${wtk.home}\lib\wma11.jar"/>
        <pathelement location="${wtk.home}\lib\mmapi.jar"/>
        <pathelement location="lib\nokia-ui.jar"/>
        <pathelement location="lib\siemens-game.jar"/>
    </path>

    <path id="fc.hack.cp">
        <pathelement location="tmp/build/classes"/>
        <pathelement location="tools/classes"/>
        <pathelement location="Z:\alljars\bcel-5.1\bcel-5.1.jar"/>
    </path>

    <property name="classpath.proguard" value="Z:\apps\proguard3.6\lib\proguard.jar"/>

    <target name="all">
        <antcall target="jsr75"/>
        <antcall target="x65"/>
        <antcall target="a780"/>
    </target>

    <target name="jsr75">
        <property name="suffix" value=""/>
        <property name="dist.dir" value="jsr75"/>
        <property name="classpath.preverify" value="${wtk.home}\lib\cldcapi11.jar;${wtk.home}\lib\midpapi20.jar;${wtk.home}\lib\jsr75.jar;${wtk.home}\lib\jsr082.jar;${wtk.home}\lib\jsr179.jar;${wtk.home}\lib\wma11.jar"/>
        <property name="libraryjars" value="${wtk.home}\lib\cldcapi11.jar;${wtk.home}\lib\midpapi20.jar;${wtk.home}\lib\jsr75.jar;${wtk.home}\lib\jsr082.jar;${wtk.home}\lib\jsr179.jar;${wtk.home}\lib\wma11.jar"/>
        <antcall target="clean"/>
        <antcall target="a.pre.jsr75"/>
        <antcall target="compile"/>
        <antcall target="a.pack" inheritall="true"/>
        <antcall target="obfuscate" inheritall="true"/>
        <antcall target="preverify" inheritall="true"/>
        <antcall target="a.pack.obfuscated" inheritall="true"/>
        <antcall target="sign.and.update" inheritall="true"/>
    </target>

    <target name="x65">
        <property name="suffix" value="-x65"/>
        <property name="dist.dir" value="x65"/>
        <property name="libraryjars" value="${wtk.home}\lib\cldcapi11.jar;${wtk.home}\lib\midpapi20.jar;${wtk.home}\lib\jsr082.jar;${wtk.home}\lib\jsr179.jar;${wtk.home}\lib\wma11.jar"/>
        <property name="classpath.preverify" value="${wtk.home}\lib\cldcapi11.jar;${wtk.home}\lib\midpapi20.jar;${wtk.home}\lib\jsr082.jar;${wtk.home}\lib\jsr179.jar;${wtk.home}\lib\wma11.jar"/>
        <antcall target="clean"/>
        <antcall target="a.pre.x65"/>
        <antcall target="compile"/>
        <antcall target="a.pack" inheritall="true"/>
        <antcall target="obfuscate" inheritall="true"/>
        <antcall target="preverify" inheritall="true"/>
        <antcall target="a.pack.obfuscated" inheritall="true"/>
        <antcall target="sign.and.update" inheritall="true"/>
    </target>

    <target name="a780">
        <property name="suffix" value="-a780"/>
        <property name="dist.dir" value="a780"/>
        <property name="libraryjars" value="${wtk.home}\lib\cldcapi11.jar;${wtk.home}\lib\midpapi20.jar;${wtk.home}\lib\jsr082.jar;${wtk.home}\lib\jsr179.jar;${wtk.home}\lib\wma11.jar"/>
        <property name="classpath.preverify" value="${wtk.home}\lib\cldcapi11.jar;${wtk.home}\lib\midpapi20.jar;${wtk.home}\lib\jsr082.jar;${wtk.home}\lib\jsr179.jar;${wtk.home}\lib\wma11.jar"/>
        <antcall target="clean"/>
        <antcall target="a.pre.a780"/>
        <antcall target="compile"/>
        <antcall target="a.pack" inheritall="true"/>
        <antcall target="obfuscate" inheritall="true"/>
        <antcall target="preverify" inheritall="true"/>
        <antcall target="a.pack.obfuscated" inheritall="true"/>
        <antcall target="sign.and.update" inheritall="true"/>
    </target>

    <target name="clean">
        <delete dir="tmp"/>
    </target>

    <target name="a.pre.jsr75">
        <mkdir dir="tmp/src"/>
        <wtkpreprocess srcdir="src" destdir="tmp/src" symbols="__JSR75__"/>
    </target>

    <target name="a.pre.x65">
        <mkdir dir="tmp/src"/>
        <wtkpreprocess srcdir="src" destdir="tmp/src" symbols="__S65__"/>
    </target>

    <target name="a.pre.a780">
        <mkdir dir="tmp/src"/>
        <wtkpreprocess srcdir="src" destdir="tmp/src" symbols="__A780__"/>
    </target>

    <target name="compile">
        <mkdir dir="tmp/build/classes"/>
        <javac srcdir="tmp/src"
               destdir="tmp/build/classes"
               fork="true"
               target="1.1" source="1.3"
               bootclasspathref="bootclasspath"/>
    </target>

    <target name="a.pack">
        <copy file="trekbuddy.jad" tofile="tmp/trekbuddy${suffix}.jad" overwrite="true"/>
        <wtkpackage jarfile="tmp/trekbuddy${suffix}.jar"
                    jadfile="tmp/trekbuddy${suffix}.jad">
            <fileset dir="tmp/build/classes"/>
            <fileset dir="res"/>
        </wtkpackage>
    </target>

    <target name="a.pack.obfuscated">
        <delete>
          <fileset dir="dist/${dist.dir}" includes="**/*.jar"/>
        </delete>
        <wtkjad jadfile="dist/${dist.dir}/trekbuddy${suffix}.jad"
                name="TrekBuddy"
                vendor="KrUcH"
                version="0.9.5">
            <midlet name="TrekBuddy" class="cz.kruch.track.TrackingMIDlet"/>
            <!--
            <attribute name="MicroEdition-Configuration" value="CLDC-${wtk.cldc.version}"/>
            <attribute name="MicroEdition-Profile" value="MIDP-${wtk.midp.version}"/>
            -->
		<attribute name="MIDlet-Description" value="GPS Tracking"/>
		<attribute name="MIDlet-Info-URL" value="www.trekbuddy.net"/>
            <attribute name="MIDlet-Permissions-Opt" value="javax.microedition.io.Connector.file.read,javax.microedition.io.Connector.file.write,javax.microedition.io.Connector.bluetooth.client,javax.microedition.location.Location,javax.microedition.media.control.VideoControl.getSnapshot,javax.microedition.io.Connector.sms,javax.wireless.messaging.sms.receive"/>
        </wtkjad>
        <wtkpackage jarfile="dist/${dist.dir}/trekbuddy${suffix}.jar"
                    jadfile="dist/${dist.dir}/trekbuddy${suffix}.jad">
            <fileset dir="tmp/preverified"/>
            <fileset dir="res"/>
        </wtkpackage>
        <!--
        <wtkjad jadfile="dist/${dist.dir}/trekbuddy${suffix}.jad"
                update="true">
            <attribute name="Datum-1" value="S-42 (Poland){Krassovsky 1940,23,-124,-82}=map:Pulkovo 1942 POL"/>
        </wtkjad>
        -->
    </target>

    <target name="sign.and.update">
        <java jar="c:\WTK25\bin\JadTool.jar" fork="true">
            <arg line="-addcert -certnum 1 -alias 'trekbuddy' -keystore trekbuddy.jks -inputjad dist/${dist.dir}/trekbuddy${suffix}.jad -outputjad dist/${dist.dir}/_trekbuddy${suffix}.jad"/>
        </java>
        <move file="dist/${dist.dir}/_trekbuddy${suffix}.jad" tofile="dist/${dist.dir}/trekbuddy${suffix}.jad"/>
        <java jar="c:\WTK25\bin\JadTool.jar" fork="true">
            <arg line="-addcert -certnum 2 -alias 'trekbuddy' -keystore trekbuddy.jks -inputjad dist/${dist.dir}/trekbuddy${suffix}.jad -outputjad dist/${dist.dir}/_trekbuddy${suffix}.jad"/>
        </java>
        <move file="dist/${dist.dir}/_trekbuddy${suffix}.jad" tofile="dist/${dist.dir}/trekbuddy${suffix}.jad"/>
        <java jar="c:\WTK25\bin\JadTool.jar" fork="true">
            <arg line="-addcert -certnum 3 -alias 'trekbuddy' -keystore trekbuddy.jks -inputjad dist/${dist.dir}/trekbuddy${suffix}.jad -outputjad dist/${dist.dir}/_trekbuddy${suffix}.jad"/>
        </java>
        <move file="dist/${dist.dir}/_trekbuddy${suffix}.jad" tofile="dist/${dist.dir}/trekbuddy${suffix}.jad"/>
        <java jar="c:\WTK25\bin\JadTool.jar" fork="true">
            <arg line="-addjarsig -alias 'trekbuddy' -keystore trekbuddy.jks -keypass changeit -jarfile dist/${dist.dir}/trekbuddy${suffix}.jar -inputjad dist/${dist.dir}/trekbuddy${suffix}.jad -outputjad dist/${dist.dir}/_trekbuddy${suffix}.jad"/>
        </java>
        <move file="dist/${dist.dir}/_trekbuddy${suffix}.jad" tofile="dist/${dist.dir}/trekbuddy${suffix}.jad"/>
        <wtkjad jadfile="dist/${dist.dir}/trekbuddy${suffix}.jad" update="true">
            <attribute name="Datum-1" value="S-42 (Poland){Krassovsky 1940,23,-124,-82}=map:Pulkovo 1942 POL"/>
        </wtkjad>
    </target>

    <target name="obfuscate">
	  <java jar="Z:\apps\proguard3.6\lib\proguard.jar" fork="true">
            <arg value="-injars tmp/trekbuddy${suffix}.jar"/>
            <arg value="-outjars tmp/trekbuddy${suffix}-obfuscated.jar"/>
            <arg value="-libraryjars ${libraryjars}"/>
            <arg value="-dontusemixedcaseclassnames"/>
            <arg value="-defaultpackage ''"/>
            <arg value="-overloadaggressively"/>
            <arg value="-allowaccessmodification"/>
            <arg value="-keep public class cz.kruch.track.TrackingMIDlet"/>
            <arg value="-keepnames class org.**"/>
            <arg value="-keepnames class cz.** extends java.lang.Exception"/>
            <arg value="-assumenosideeffects class cz.kruch.track.util.Logger { *; }"/>
            <arg value="-whyareyoukeeping class henson.midp.Float"/>
            <arg value="-whyareyoukeeping class cz.kruch.track.util.Logger"/>
            <arg value="-whyareyoukeeping class cz.kruch.track.util.CharBuffer"/>
            <arg value="-whyareyoukeeping class cz.kruch.j2se.io.BufferedReader"/>
            <arg value="-whyareyoukeeping class cz.kruch.j2se.util.StringTokenizer"/>
            <arg value="-printmapping dist/${dist.dir}/trekbuddy${suffix}.map"/>
            <arg value="-verbose"/>
        </java>
    </target> 
	
	<target name="preverify">
	    <unjar src="tmp/trekbuddy${suffix}-obfuscated.jar" dest="tmp/obfuscated"/>
		<exec executable="${wtk.home}\bin\preverify1.1.exe">
			<arg line="-classpath ${classpath.preverify} -d tmp/preverified tmp/obfuscated"/>
		</exec>
	</target>

<!--	

	<target name="fc.hack.x65">
		<echo message="Change JSR-75 FileConnection to Siemens FileConnection"/>
		<mkdir dir="tmp/hack/siemens/api/file"/>
		<java classname="FileConnectionApiSiemensFix" fork="true">
			<arg line="api.file.File tmp/hack/siemens/api/file/File.class"/>
			<classpath refid="fc.hack.cp"/>
		</java>
		<copy todir="tmp/build/classes" overwrite="true">
            <fileset dir="tmp/hack/siemens"/>
        </copy>
	</target>

	<target name="fc.hack.a780">
		<echo message="Change JSR-75 FileConnection to Motorola FileConnection"/>
		<mkdir dir="tmp/hack/motorola/api/file"/>
		<java classname="FileConnectionApiMotorolaFix" fork="true">
			<arg line="api.file.File tmp/hack/motorola/api/file/File.class"/>
			<classpath refid="fc.hack.cp"/>
		</java>
		<copy todir="tmp/build/classes" overwrite="true">
            <fileset dir="tmp/hack/motorola"/>
        </copy>
	</target>

-->

</project>
